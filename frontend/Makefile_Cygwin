#
# build the grgen-tool, grrr
#
PARSER_DIR = de/unika/ipd/grgen/parser/antlr
ANTLR_JAR  = jars/antlr.jar
JARGS_JAR  = jars/jargs.jar

ANTLR = java -cp ../../../../../../$(ANTLR_JAR) antlr.Tool

GRGENNET ?= ../engine-net/out/bin/

all:	grgen

grgen: .grammar
	@if [ ! -e .generator_build ]; then \
	  $(MAKE) -f Makefile_Cygwin .generator_build; \
	else \
	  if [ "`find . -type f -name "*.java" -cnewer .generator_build`" != "" ]; then \
	    $(MAKE) -f Makefile_Cygwin .generator_build; \
	  fi; \
	fi

.generator_build: dir .grammar
	find de -type f -name "*.java" | xargs javac -d build -classpath "$(ANTLR_JAR);$(JARGS_JAR)" -source 1.5
	jar -cf grgen.jar -C build .
	cp grgen.jar $(GRGENNET)
	@touch .generator_build

.PHONY: dir
dir:
	test -d build || mkdir build

.grammar: $(PARSER_DIR)/lexer.g $(PARSER_DIR)/base.g $(PARSER_DIR)/types.g $(PARSER_DIR)/actions.g $(ANTLR_JAR)
	cd $(PARSER_DIR) && $(ANTLR) lexer.g
	cd $(PARSER_DIR) && $(ANTLR) base.g
	cd $(PARSER_DIR) && $(ANTLR) -glib base.g types.g
	cd $(PARSER_DIR) && $(ANTLR) -glib base.g actions.g
	@touch .grammar

clean:
	rm -rf build/* .generator_build .grammar
